---
- hosts: localhost

  tasks:
    - name: Logon to CyberArk PAM REST API using CyberArk authn
      cyberark.pas.cyberark_authentication:
        api_base_url: "{{ CYBERARK_API_URL }}"
        username: "{{ CYBERARK_API_USERNAME }}"
        password: "{{ CYBERARK_API_PASSWORD }}"
        use_cyberark_authentication: yes
      when: CYBERARK_API_AUTH_TYPE == 'cyberark'

    - name: Logon to CyberArk PAM REST API using LDAP authn
      cyberark.pas.cyberark_authentication:
        api_base_url: "{{ CYBERARK_API_URL }}"
        username: "{{ CYBERARK_API_USERNAME }}"
        password: "{{ CYBERARK_API_PASSWORD }}"
        use_ldap_authentication: yes
      when: CYBERARK_API_AUTH_TYPE == 'ldap'
    
    - name: Error message for Windows or Radius authn
      ansible.builtin.debug:
        msg: "Windows or Radius authentication is not supported."
      when: CYBERARK_API_AUTH_TYPE == 'windows' or CYBERARK_API_AUTH_TYPE == 'radius'

    - name: Create Test Safe
      ansible.builtin.uri:
        url: "{{ CYBERARK_API_URL }}/PasswordVault/api/safes"
        method: POST
        headers:
          Content-Type: application/json
          Authorization: "{{ cyberark_session.token }}"
        body_format: json
        body:
          SafeName: "{{ safe }}"
          Description: "{{ description }}"
          OLACEnabled: "{{ olac }}"
          ManagingCPM: "{{ managingCPM }}"
          NumberOfDaysRetention: "{{ daysretention }}"
          AutoPurgeEnabled: "{{ autopurge }}"
        status_code: 201
      register: cyberarkaction

    - name: Debug msg
      ansible.builtin.debug:
        msg: "{{ cyberarkaction }}"

    - name: Logoff CyberArk PAM REST API
      cyberark.pas.cyberark_authentication:
        cyberark_session: "{{ cyberark_session }}"
        state: absent
      ignore_errors: yes
