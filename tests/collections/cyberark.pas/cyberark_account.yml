---
- hosts: localhost

  tasks:
    - name: Logon to CyberArk PAM REST API using CyberArk authn
      cyberark.pas.cyberark_authentication:
        api_base_url: "{{ CYBERARK_API_URL }}"
        username: "{{ CYBERARK_API_USERNAME }}"
        password: "{{ CYBERARK_API_PASSWORD }}"
        use_cyberark_authentication: yes
      when: CYBERARK_API_AUTH_TYPE == 'cyberark' or CYBERARK_API_AUTH_TYPE not defined
 
    - name: Logon to CyberArk PAM REST API using LDAP authn
      cyberark.pas.cyberark_authentication:
        api_base_url: "{{ CYBERARK_API_URL }}"
        username: "{{ CYBERARK_API_USERNAME }}"
        password: "{{ CYBERARK_API_PASSWORD }}"
        use_ldap_authentication: yes
      when: CYBERARK_API_AUTH_TYPE == 'ldap'

    - name: Onboard Account
      cyberark.pas.cyberark_account:
        identified_by: "address,username"
        safe: "Test-Ansible"
        address: "cyberark.local"
        username: "cyberark-administrator"
        platform_id: WinDomain
        secret: "CyberarkFirst"
        platform_account_properties:
            LogonDomain: "RedHatAnsible"
        secret_management:
            automatic_management_enabled: true
        state: present
        cyberark_session: "{{ cyberark_session }}"
      register: cyberarkaction

    - name: Debug message
      ansible.builtin.debug:
        var: cyberarkaction

    - name: Offboard Account
      cyberark.pas.cyberark_account:
        identified_by: "address,username"
        safe: "Test"
        address: "cyberark.local"
        username: "cyberark-administrator"
        state: absent
        cyberark_session: "{{ cyberark_session }}"
      register: cyberarkaction

    - name: Debug message
      ansible.builtin.debug:
        var: cyberarkaction

    - name: Logoff from CyberArk Vault
      cyberark.pas.cyberark_authentication:
        state: absent
        cyberark_session: "{{ cyberark_session }}"
